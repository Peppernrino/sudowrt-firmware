#!/bin/sh 

. /usr/share/libubox/jshn.sh

LOG=/var/log/retrieve_ip.log
MESHNODEDB="secrets.peoplesopen.net"
MESHNODEDB_IP="138.68.252.190"
USER="deployer"
PASS="praisebob"
POSTURL="https://$USER:$PASS@$MESHNODEDB/nodes"

# before running you'll need to install curl and ca-certificates with
# opkg update
# opkg install curl
# opkg install ca-certificates

echo "running 99_meship to retrieve an IP address from" $MESHNODEDB >>$LOG

# check for internet connection for every 10s
for i in 1 2 3 4 5;
do
  if ping -q -c 1 -W 1 8.8.8.8 >/dev/null; then
    echo "IPv4 is up" >>$LOG
    break
  else
    echo "IPv4 is down" >>$LOG
  fi
  sleep 10
done

if ping -q -c 1 -W 1 google.com >/dev/null; then
  echo "DNS is working" >>$LOG
else
  echo "DNS is not working" >>$LOG
  exit 1
fi

if ping -q -c 1 -W 1 $MESHNODEDB >/dev/null; then
  echo $MESHNODEDB "is reachable" >>$LOG
else
  echo $MESHNODEDB "is not reachable" >>$LOG
  echo "trying by IP" $MESHNODEDB_IP >>$LOG
  if ping -q -c 1 -W 1  $MESHNODEDB_IP >/dev/null; then
    echo $MESHNODEDB_IP "is reachable" >>$LOG
  else
    echo $MESHNODEDB_IP "is not reachable" >>$LOG
    exit 1
  fi
fi

echo "posting to" $POSTURL >>$LOG

MESHNODE_DATA=$(curl -X POST -H "Content-Type: application/x-www-form-urlencoded" --data-urlencode data='{"type":"node"}' $POSTURL )

json_load "$MESHNODE_DATA"
json_select data 
json_get_var MESHIP mesh_addr_ipv4 
echo "recieved mesh IP:" $MESHIP >>$LOG

uci set network.ext1mesh.ipaddr=$MESHIP
uci set network.ext2mesh.ipaddr=$MESHIP
uci set network.mesh2.ipaddr=$MESHIP
uci set network.mesh5.ipaddr=$MESHIP
uci set network.open.ipaddr=$MESHIP

echo "committing new mesh IP" $MESHIP "to uci settings" >>$LOG
uci commit network

# remove cron job and delete yourself
sed -i '/retrieve_ip/d' /etc/crontabs/root
rm -- "$0"
